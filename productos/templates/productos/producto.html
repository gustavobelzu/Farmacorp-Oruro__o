{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>FARMACORP</title>
    <link rel="stylesheet" href="{% static 'styles.css' %}">
    <style>
        body { font-family: Arial,sans-serif; margin:0; padding:0; display:flex; background:#e3f2fd; }
        .sidebar { width:250px; background:#2196f3; color:#fff; height:100vh; display:flex; flex-direction:column; position:fixed; }
        .sidebar-header { text-align:center; padding:20px 10px; border-bottom:2px solid #1976d2; }
        .sidebar-header img { width:80px; height:auto; }
        .sidebar-header h2 { margin:10px 0 0; font-size:1.5em; }
        .menu { flex:1; display:flex; flex-direction:column; padding:20px 0; }
        .menu a { display:flex; align-items:center; padding:12px 20px; color:white; text-decoration:none; font-weight:bold; transition:background 0.2s; }
        .menu a img { width:28px; margin-right:12px; }
        .menu a:hover { background:#1e88e5; }
        .logout-btn { margin:20px; background:#64b5f6; color:#fff; border:none; padding:10px; border-radius:8px; font-weight:bold; cursor:pointer; transition:background 0.2s; }
        .logout-btn:hover { background:#1e88e5; }
        .main-content { margin-left:250px; flex:1; padding:20px 40px; }
        h1 { text-align:center; color:#0d47a1; }
        table { width:100%; border-collapse:collapse; }
        th, td { padding:10px; border:1px solid #1976d2; text-align:left; }
        th { background:#2196f3; color:white; }
        @media (max-width:700px){ body{flex-direction:column;} .sidebar{width:100%;height:auto;} .main-content{margin-left:0;} }

        /* Botones arriba */
        .top-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        .top-buttons a {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        color: white;
        background-color: #64b5f6;
        padding: 8px 16px;
        border-radius: 6px;
        text-decoration: none;
        font-weight: bold;
        font-size: 13px;
        min-width: 100px;   /* evita que el texto se desborde */
        text-align: center;
        box-sizing: border-box;
        transition: background 0.2s, transform 0.1s;
    }

    .top-buttons a:hover {
        background-color: #1e88e5;
        transform: scale(1.03);
    }

    .top-buttons a.delete {
        background-color: #e53935;
        min-width: 110px; /* un poco m√°s ancho solo para ‚ÄúEliminar‚Äù */
    }

    .top-buttons a.delete:hover {
        background-color: #c62828;
    }

    .top-buttons a.edit {
        background-color: #fbc02d;
        color: black;
    }

    .top-buttons a.edit:hover {
        background-color: #f9a825;
    }
    /* === Personalizaci√≥n del cuadro SweetAlert2 === */
    .swal2-popup {
        border-radius: 12px;
        padding: 25px 20px;
    }

    .swal2-input {
        width: 80% !important;      /* ancho del cuadro de texto */
        height: 40px !important;    /* alto del cuadro de texto */
        font-size: 15px;
        border: 2px solid #2196f3;
        border-radius: 6px;
        padding: 8px 10px;
    }

    .swal2-title {
        color: #0d47a1;
        font-weight: bold;
    }

    .swal2-confirm {
        background-color: #2196f3 !important;
        color: white !important;
        border-radius: 6px !important;
        font-weight: bold;
        padding: 8px 18px !important;
    }

    .swal2-cancel {
        background-color: #e53935 !important;
        color: white !important;
        border-radius: 6px !important;
        font-weight: bold;
        padding: 8px 18px !important;
    }

    </style>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header">
            <img src="https://veltio.com/wp-content/uploads/2022/03/Farmacorp-logo.jpg" alt="Logo Farmacorp">
            <h2>FARMACORP</h2>
        </div>
        <div class="menu">
            <a href="{% url 'sucursal' %}"><img src="https://cdn-icons-png.flaticon.com/128/13163/13163163.png" alt="Sucursal">SUCURSAL</a>
            <a href="{% url 'producto_listar' %}"><img src="https://cdn-icons-png.flaticon.com/128/647/647237.png" alt="Productos">PRODUCTOS</a>
            <a href="{% url 'inventario' %}"><img src="https://cdn-icons-png.flaticon.com/128/2825/2825867.png" alt="Inventario">INVENTARIO</a>
            <a href="{% url 'empleado' %}"><img src="https://cdn-icons-png.flaticon.com/512/219/219983.png" alt="Empleados">EMPLEADOS</a>
            <a href="{% url 'cliente' %}"><img src="https://cdn-icons-png.flaticon.com/128/6012/6012311.png" alt="Clientes">CLIENTES</a>
            <a href="{% url 'receta' %}"><img src="https://cdn-icons-png.flaticon.com/128/4521/4521516.png" alt="Recetas">RECETAS</a>
            <a href="{% url 'proveedor' %}"><img src="https://cdn-icons-png.flaticon.com/128/10839/10839198.png" alt="Proveedores">PROVEEDORES</a>
            <a href="{% url 'reporte' %}"><img src="https://cdn-icons-png.flaticon.com/128/1055/1055644.png" alt="Reportes">REPORTES</a>
            <a href="{% url 'alerta' %}"><img src="https://cdn-icons-png.flaticon.com/512/564/564619.png" alt="Alertas">ALERTAS</a>
            <a href="{% url 'venta' %}"><img src="https://cdn-icons-png.flaticon.com/128/9362/9362302.png" alt="Ventas">VENTAS</a>
        </div>
        {% if usuario %}
        <form method="post" action="{% url 'logout' %}">
            {% csrf_token %}
            <button type="submit" class="logout-btn">Cerrar sesi√≥n</button>
        </form>
        {% endif %}
    </div>

    <div class="main-content">
        <h1>Listado de Productos</h1>

        <div class="top-buttons">
            <a href="{% url 'crear_producto' %}">Crear</a>
            <a href="#" class="edit" onclick="editarProducto()">Editar</a>
            <a href="#" class="delete" onclick="confirmarEliminacion()">Eliminar</a>
            <a href="{% url 'dashboard' %}">Volver al Men√∫</a>
        </div>

        <table>
            <tr>
                <th>C√≥digo</th>
                <th>Nombre</th>
                <th>Descripci√≥n</th>
                <th>Precio</th>
                <th>Stock</th>
                <th>Vencimiento</th>
                <th>IVA</th>
                <th>Inventario</th>
                <th>Cliente</th>
            </tr>
            {% for producto in productos %}
            <tr>
                <td>{{ producto.codigo_barra }}</td>
                <td>{{ producto.nombre }}</td>
                <td>{{ producto.descripcion }}</td>
                <td>{{ producto.precio_unitario }}</td>
                <td>{{ producto.stock }}</td>
                <td>{{ producto.fecha_vencimiento }}</td>
                <td>{{ producto.iva }}</td>
                <td>{{ producto.id_inventario }}</td>
                <td>{{ producto.ci_cliente }}</td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="9" style="text-align:center;">No hay productos registrados.</td>
            </tr>
            {% endfor %}
        </table>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
    function confirmarEliminacion() {
        Swal.fire({
            title: 'Eliminar Producto',
            input: 'text',
            inputLabel: 'Ingrese el c√≥digo del producto a eliminar',
            inputPlaceholder: 'C√≥digo del producto',
            showCancelButton: true,
            confirmButtonText: 'Aceptar',
            cancelButtonText: 'Cancelar',
            inputValidator: (value) => {
                if (!value) return 'Debes ingresar un c√≥digo';
            }
        }).then((result) => {
            if (result.isConfirmed) {
                const codigo = result.value.trim();
                
                // üîç Verificar si el producto existe antes de eliminar
                fetch(`/productos/verificar/${codigo}/`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.existe) {
                            // Si existe, confirmar eliminaci√≥n
                            Swal.fire({
                                title: `¬øEliminar producto ${codigo}?`,
                                icon: 'warning',
                                showCancelButton: true,
                                confirmButtonText: 'S√≠, eliminar',
                                cancelButtonText: 'Cancelar',
                                confirmButtonColor: '#e53935'
                            }).then((confirmResult) => {
                                if (confirmResult.isConfirmed) {
                                    const form = document.createElement('form');
                                    form.method = 'POST';
                                    form.action = `/productos/eliminar/${codigo}/`;

                                    const csrfInput = document.createElement('input');
                                    csrfInput.type = 'hidden';
                                    csrfInput.name = 'csrfmiddlewaretoken';
                                    csrfInput.value = '{{ csrf_token }}';
                                    form.appendChild(csrfInput);

                                    document.body.appendChild(form);
                                    form.submit();
                                }
                            });
                        } else {
                            // ‚ö†Ô∏è Producto no encontrado
                            Swal.fire({
                                icon: 'error',
                                title: 'Producto no encontrado',
                                text: `No existe ning√∫n producto con el c√≥digo "${codigo}".`,
                                confirmButtonColor: '#3085d6'
                            });
                        }
                    })
                    .catch(error => {
                        console.error(error);
                        Swal.fire({
                            icon: 'error',
                            title: 'Error en la verificaci√≥n',
                            text: 'Ocurri√≥ un problema al verificar el producto.',
                            confirmButtonColor: '#3085d6'
                        });
                    });
            }
        });
    }

    function editarProducto() {
        Swal.fire({
            title: 'Editar Producto',
            input: 'text',
            inputLabel: 'Ingrese el c√≥digo del producto a editar',
            inputPlaceholder: 'C√≥digo del producto',
            showCancelButton: true,
            confirmButtonText: 'Aceptar',
            cancelButtonText: 'Cancelar',
            inputValidator: (value) => {
                if (!value) return 'Debes ingresar un c√≥digo';
            }
        }).then((result) => {
            if(result.isConfirmed){
                const codigo = result.value.trim();

                // üîç Verificar si el producto existe
                fetch(`/productos/verificar/${codigo}/`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.existe) {
                            // Redirigir a la p√°gina de edici√≥n
                            window.location.href = `/productos/editar/${codigo}/`;
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Producto no encontrado',
                                text: `No existe ning√∫n producto con el c√≥digo "${codigo}".`,
                                confirmButtonColor: '#3085d6'
                            });
                        }
                    })
                    .catch(error => {
                        console.error(error);
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'Ocurri√≥ un problema al verificar el producto.',
                            confirmButtonColor: '#3085d6'
                        });
                    });
            }
        });
    }
   
    </script>
        {% if producto_eliminado %}
    <script>
    Swal.fire({
        icon: 'success',
        title: '‚úÖ Producto eliminado correctamente',
        confirmButtonText: 'Aceptar',
        confirmButtonColor: '#3085d6'
    }).then(() => {
        window.location.href = "{% url 'producto_listar' %}";
    });
    </script>
    {% endif %}

</body>
</html>
