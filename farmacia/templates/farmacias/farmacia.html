{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>FARMACORP - Farmacias</title>
    <link rel="stylesheet" href="{% static 'styles.css' %}">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { font-family: Arial,sans-serif; margin:0; padding:0; display:flex; background:#e3f2fd; }
        .sidebar { width:250px; background:#2196f3; color:#fff; height:100vh; display:flex; flex-direction:column; position:fixed; }
        .sidebar-header { text-align:center; padding:20px 10px; border-bottom:2px solid #1976d2; }
        .sidebar-header img { width:80px; height:auto; }
        .sidebar-header h2 { margin:10px 0 0; font-size:1.5em; }
        .menu { flex:1; display:flex; flex-direction:column; padding:20px 0; }
        .menu a { display:flex; align-items:center; padding:12px 20px; color:white; text-decoration:none; font-weight:bold; transition:background 0.2s; }
        .menu a img { width:28px; margin-right:12px; }
        .menu a:hover { background:#1e88e5; }
        .logout-btn { margin:20px; background:#64b5f6; color:#fff; border:none; padding:10px; border-radius:8px; font-weight:bold; cursor:pointer; transition:background 0.2s; }
        .logout-btn:hover { background:#1e88e5; }
        .main-content { margin-left:250px; flex:1; padding:20px 40px; }
        h1 { text-align:center; color:#0d47a1; }
        table { width:100%; border-collapse:collapse; margin-top:20px; }
        th, td { padding:10px; border:1px solid #1976d2; text-align:left; }
        th { background:#2196f3; color:white; }

        .top-buttons { display:flex; justify-content:center; gap:10px; margin-bottom:20px; }
        .top-buttons a { display:inline-flex; align-items:center; justify-content:center; color:white; background-color:#64b5f6; padding:8px 16px; border-radius:6px; text-decoration:none; font-weight:bold; font-size:13px; min-width:100px; text-align:center; transition:background 0.2s, transform 0.1s; }
        .top-buttons a:hover { background-color:#1e88e5; transform:scale(1.03); }
        .top-buttons a.delete { background-color:#e53935; min-width:110px; }
        .top-buttons a.delete:hover { background-color:#c62828; }
        .top-buttons a.edit { background-color:#fbc02d; color:black; }
        .top-buttons a.edit:hover { background-color:#f9a825; }

        .swal2-popup { border-radius:12px; padding:25px 20px; }
        .swal2-input { width:80% !important; height:40px !important; font-size:15px; border:2px solid #2196f3; border-radius:6px; padding:8px 10px; }
        .swal2-title { color:#0d47a1; font-weight:bold; }
        .swal2-confirm { background-color:#2196f3 !important; color:white !important; border-radius:6px !important; font-weight:bold; padding:8px 18px !important; }
        .swal2-cancel { background-color:#e53935 !important; color:white !important; border-radius:6px !important; font-weight:bold; padding:8px 18px !important; }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header">
            <img src="https://veltio.com/wp-content/uploads/2022/03/Farmacorp-logo.jpg" alt="Logo Farmacorp">
            <h2>FARMACORP</h2>
        </div>
        <div class="menu">
            <a href="{% url 'farmacia:listar_farmacias' %}"><img src="https://cdn-icons-png.flaticon.com/128/13163/13163163.png" alt="Sucursal">FARMACIAS</a>
            <a href="{% url 'empleados:listar_empleados' %}"><img src="https://cdn-icons-png.flaticon.com/512/219/219983.png" alt="Empleados">EMPLEADOS</a>
            <a href="{% url 'dashboard' %}">MENÚ PRINCIPAL</a>
        </div>
        {% if usuario %}
        <form method="post" action="{% url 'logout' %}">
            {% csrf_token %}
            <button type="submit" class="logout-btn">Cerrar sesión</button>
        </form>
        {% endif %}
    </div>

    <div class="main-content">
        <h1>Listado de Farmacias</h1>

        <div class="top-buttons">
            <a href="{% url 'farmacia:crear_farmacia' %}">Crear</a>
            <a href="#" class="edit" onclick="editarFarmacia()">Editar</a>
            <a href="#" class="delete" onclick="confirmarEliminacion()">Eliminar</a>
            <a href="{% url 'dashboard' %}">Volver al Menú</a>
        </div>

        <table>
            <tr>
                <th>ID</th>
                <th>Nombre Farmacia</th>
                <th>Razón Legal</th>
                <th>Sucursal</th>
                <th>Departamento</th>
                <th>Dirección</th>
                <th>Email</th>
                <th>NIT</th>
                <th>Horario</th>
            </tr>
            {% for f in farmacias %}
            <tr>
                <td>{{ f.id }}</td>
                <td>{{ f.nombre_farmacia }}</td>
                <td>{{ f.razon_legal|default:"—" }}</td>
                <td>{{ f.id_sucursal.nombre }}</td>
                <td>{{ f.id_sucursal.departamento|default:"—" }}</td>
                <td>{{ f.id_sucursal.direccion|default:"—" }}</td>
                <td>{{ f.id_sucursal.email|default:"—" }}</td>
                <td>{{ f.id_sucursal.nit|default:"—" }}</td>
                <td>{{ f.id_sucursal.horario|default:"—" }}</td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="9" style="text-align:center;">No hay farmacias registradas.</td>
            </tr>
            {% endfor %}
        </table>
    </div>

<script>
function confirmarEliminacion() {
    Swal.fire({
        title: 'Eliminar Farmacia',
        input: 'text',
        inputLabel: 'Ingrese el ID de la farmacia a eliminar',
        inputPlaceholder: 'ID Farmacia',
        showCancelButton: true,
        confirmButtonText: 'Aceptar',
        cancelButtonText: 'Cancelar',
        inputValidator: (value) => { if(!value) return 'Debes ingresar un ID'; }
    }).then((result) => {
        if(result.isConfirmed){
            const id = result.value.trim();
            fetch(`/farmacia/verificar/${id}/`)
                .then(res => res.json())
                .then(data => {
                    if(data.existe){
                        Swal.fire({
                            title: `¿Eliminar farmacia ${id}?`,
                            icon: 'warning',
                            showCancelButton: true,
                            confirmButtonText: 'Sí, eliminar',
                            cancelButtonText: 'Cancelar',
                            confirmButtonColor: '#e53935'
                        }).then((confirmResult) => {
                            if(confirmResult.isConfirmed){
                                const form = document.createElement('form');
                                form.method='POST';
                                form.action=`/farmacia/eliminar/${id}/`;
                                const csrfInput = document.createElement('input');
                                csrfInput.type='hidden';
                                csrfInput.name='csrfmiddlewaretoken';
                                csrfInput.value='{{ csrf_token }}';
                                form.appendChild(csrfInput);
                                document.body.appendChild(form);
                                form.submit();
                            }
                        });
                    } else {
                        Swal.fire({icon:'error', title:'Farmacia no encontrada', text:`No existe ninguna farmacia con ID "${id}".`, confirmButtonColor:'#3085d6'});
                    }
                });
        }
    });
}

function editarFarmacia() {
    Swal.fire({
        title:'Editar Farmacia',
        input:'text',
        inputLabel:'Ingrese el ID de la farmacia a editar',
        inputPlaceholder:'ID Farmacia',
        showCancelButton:true,
        confirmButtonText:'Aceptar',
        cancelButtonText:'Cancelar',
        inputValidator: (value) => { if(!value) return 'Debes ingresar un ID'; }
    }).then((result)=>{
        if(result.isConfirmed){
            const id = result.value.trim();
            fetch(`/farmacia/verificar/${id}/`)
                .then(res => res.json())
                .then(data => {
                    if(data.existe){
                        window.location.href = `/farmacia/editar/${id}/`;
                    } else {
                        Swal.fire({icon:'error', title:'Farmacia no encontrada', text:`No existe ninguna farmacia con ID "${id}".`, confirmButtonColor:'#3085d6'});
                    }
                });
        }
    });
}
</script>

</body>
</html>
